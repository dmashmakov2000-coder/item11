script_properties('work-in-pause')local function check_lib(name)    local ok, _ = pcall(require, name)    if not ok then sampAddChatMessage("{ff0000}[ItemLog] Ошибка: Библиотека '" .. name .. "' не найдена!", -1) end    return okendlocal samp = require('samp.events')local inicfg = require('inicfg')local ffi = require('ffi')local imgui = require('mimgui')local encoding = require('encoding')encoding.default = 'CP1251'local u8 = encoding.UTF8local effil_ok = check_lib('effil')local requests_ok = check_lib('requests')local effil = effil_ok and require('effil') or nil-- === КОНФИГУРАЦИЯ ===local SCRIPT_VERSION = "0.1.5" -- Обновлена версияlocal UPDATE_URL = "https://raw.githubusercontent.com/dmashmakov2000-coder/item11/main/Item.lua"local SCRIPT_CONFIG_NAME = 'Item'local SCRIPT_CONFIG_FILENAME = SCRIPT_CONFIG_NAME .. '.ini'local logoTexture = nillocal function loadLogo()    local path = thisScript().path:match("(.*[/\\])") .. "logo.png"  -- путь к logo.png    local ok, tex = pcall(imgui.createTextureFromFile, path)    if ok and tex then        logoTexture = tex    else        sampAddChatMessage("{ff0000}[ItemLog] Ошибка: не удалось загрузить logo.png", -1)    endendlocal items_name = {[673] = "Аптечка",[7037] = "Билет розыгрыша",[9729] = "Кенгурятник для BMW волшебника 2026 ",[9730] = "Кенгурятник для ЧубВоз 26 ",[9725] = "Фейерверк 2026",[9740] = "Сертификат охранника ‘Чубрик’ ",[9741] = "2к26 Монетный Ларец",[9739] = "Tier 3 Обвес Дерижабль Магната ",[9737] = "Tier 1 Обвес Дерижабль Магната ",[9738] = "Tier 2 Обвес Дерижабль Магната ",}local items = {}for id, _ in pairs(items_name) do table.insert(items, id) endtable.sort(items)local cfg = inicfg.load({    config = {        chat = '', token = '',         itemAdding = true, sendUnknownItems = false, shortMessage = false,         rentBegin = false, rentEnd = false, payday = false,         tasks = false, storage = false    }}, SCRIPT_CONFIG_NAME)local chat = imgui.new.char[128](tostring(cfg.config.chat))local token = imgui.new.char[128](tostring(cfg.config.token))local itemSearch = imgui.new.char[128]("") local itemAdding = imgui.new.bool(cfg.config.itemAdding)local sendUnknownItems = imgui.new.bool(cfg.config.sendUnknownItems)local shortMessage = imgui.new.bool(cfg.config.shortMessage)local rentBegin = imgui.new.bool(cfg.config.rentBegin)local rentEnd = imgui.new.bool(cfg.config.rentEnd)local payday = imgui.new.bool(cfg.config.payday)local tasks = imgui.new.bool(cfg.config.tasks)local storage = imgui.new.bool(cfg.config.storage)local window = imgui.new.bool(false)local activeTab = imgui.new.int(1) local getPayday = falselocal listPayday = {}-- Функция для красивых подсказокfunction HelpMarker(desc)    imgui.SameLine()    imgui.TextDisabled("(?)")    if imgui.IsItemHovered() then        imgui.BeginTooltip()        imgui.PushTextWrapPos(imgui.GetFontSize() * 35.0)        imgui.TextUnformatted(u8(desc))        imgui.PopTextWrapPos()        imgui.EndTooltip()    endend-- Telegram Logiclocal effilTelegramSendMessage = effil and effil.thread(function(text, chatID, token)    local requests = require('requests')    pcall(function()         requests.post(('https://api.telegram.org/bot%s/sendMessage'):format(token), {             params = { text = text, chat_id = chatID }        })     end)end) or nilfunction url_encode(text)    local text = string.gsub(text, "([^%w-_ %.~=])", function(c) return string.format("%%%02X", string.byte(c)) end)    return string.gsub(text, " ", "+")endfunction sendTelegramMessage(text)    local chat_id_str, token_str = ffi.string(chat), ffi.string(token)    if chat_id_str == '' or token_str == '' then return end    if not effilTelegramSendMessage then return end    local clean_text = text:gsub('{......}', '')    effilTelegramSendMessage(url_encode(u8(clean_text)), chat_id_str, token_str)endfunction checkUpdate(manual)    if not requests_ok then return end    local requests = require('requests')    lua_thread.create(function()        local ok, response = pcall(requests.get, UPDATE_URL)        if ok and response.status_code == 200 then            local remote_version = response.text:match('local SCRIPT_VERSION = "(.-)"')            if remote_version and remote_version ~= SCRIPT_VERSION then                sampAddChatMessage("[ItemLog] Найдена версия " .. remote_version .. ". Обновляю...", -1)                local file = io.open(thisScript().path, "w")                if file then file:write(response.text); file:close(); thisScript():reload() end            elseif manual then sampAddChatMessage("[ItemLog] Обновлений нет.", -1) end        end    end)endfunction saveConfig()    cfg.config.itemAdding = itemAdding[0]; cfg.config.sendUnknownItems = sendUnknownItems[0]    cfg.config.shortMessage = shortMessage[0]; cfg.config.rentBegin = rentBegin[0]    cfg.config.rentEnd = rentEnd[0]; cfg.config.payday = payday[0]    cfg.config.tasks = tasks[0]; cfg.config.storage = storage[0]    cfg.config.chat = ffi.string(chat); cfg.config.token = ffi.string(token)    inicfg.save(cfg, SCRIPT_CONFIG_FILENAME)endfunction main()    while not isSampAvailable() do wait(0) end    sampRegisterChatCommand('item', function() window[0] = not window[0] end)    checkUpdate(false)    wait(-1)end-- === ОСНОВНОЕ ОКНО ===imgui.OnFrame(function() return window[0] end, function()    local resX, resY = getScreenResolution()    imgui.SetNextWindowPos(imgui.ImVec2(resX / 2, resY / 2), imgui.Cond.FirstUseEver, imgui.ImVec2(0.5, 0.5))    imgui.SetNextWindowSize(imgui.ImVec2(750, 520), imgui.Cond.FirstUseEver)         imgui.Begin('ItemLog ' .. SCRIPT_VERSION .. ' (Unified UI)', window, imgui.WindowFlags.NoResize)        imgui.Columns(2, "main_cols", false)    imgui.SetColumnWidth(0, 160)        imgui.BeginChild("logo_frame", imgui.ImVec2(145, 100), true)        imgui.SetCursorPosX(10); imgui.SetCursorPosY(15)        imgui.Text(u8"Место для лого\n100x150 px")    imgui.EndChild()	imgui.BeginChild("logo_frame", imgui.ImVec2(145, 100), true)if logoTexture then    local size = imgui.ImVec2(145, 100)  -- размер под ваш логотип    imgui.SetCursorPosX(5)  -- отступ слева    imgui.SetCursorPosY(5)  -- отступ сверху    imgui.Image(logoTexture, size)else    imgui.SetCursorPosX(10)    imgui.SetCursorPosY(15)    imgui.Text(u8"Логотип\nне загружен")endimgui.EndChild()        imgui.Spacing()    local btn_w = 145    local btn_h = 35    if imgui.Button(u8"Уведомления", imgui.ImVec2(btn_w, btn_h)) then activeTab[0] = 1 end    imgui.Spacing()    if imgui.Button(u8"База предметов", imgui.ImVec2(btn_w, btn_h)) then activeTab[0] = 5 end     imgui.Spacing()    if imgui.Button(u8"Обновления", imgui.ImVec2(btn_w, btn_h)) then activeTab[0] = 2 end    imgui.Spacing()    if imgui.Button(u8"Новости", imgui.ImVec2(btn_w, btn_h)) then activeTab[0] = 3 end    imgui.Spacing()    if imgui.Button(u8"Настройки", imgui.ImVec2(btn_w, btn_h)) then activeTab[0] = 4 end    imgui.NextColumn()        -- Вкладка: Уведомления (ОБНОВЛЕННАЯ)    if activeTab[0] == 1 then        imgui.Text(u8"Настройки уведомлений:")        imgui.Separator() -- Оставляем разделитель после заголовка, как на скриншоте.        imgui.Spacing()                -- Главный чекбокс для предметов        if imgui.Checkbox(u8'Оповещение о добавлении предметов', itemAdding) then saveConfig() end        HelpMarker("Логирует сообщения о добавлении предметов")        -- Эти чекбоксы отображаются ТОЛЬКО если itemAdding включен        if itemAdding[0] then            imgui.Indent(20) -- Небольшой отступ для дочерних опций            if imgui.Checkbox(u8'Уведомлять о неизвестных предметах', sendUnknownItems) then saveConfig() end            HelpMarker("Логирует предметы которых нет в базе с просьбой добавить")            if imgui.Checkbox(u8'Отправлять короткое сообщение', shortMessage) then saveConfig() end            HelpMarker("Сокращяет сообщение уберает лишние строки'.")            imgui.Unindent(20)        end                imgui.Spacing()        -- Основные чекбоксы без разделителей, в один столбец        if imgui.Checkbox(u8'Оповещение об аренде', rentBegin) then saveConfig() end        HelpMarker("Оповещяет когда взяли транспорт в аренду.")        if imgui.Checkbox(u8'Аренда: Конец / Отказ', rentEnd) then saveConfig() end        HelpMarker("Оввещяет о завершении аренды.")        if imgui.Checkbox(u8'PayDay', payday) then saveConfig() end        HelpMarker("Логирует Payday.")        if imgui.Checkbox(u8'Лог побочных заданий', tasks) then saveConfig() end        HelpMarker("Логирует прогресс выполнения ежедневных квестов.")        if imgui.Checkbox(u8'Хранилище предметов', storage) then saveConfig() end        HelpMarker("Уведомляет о получении предметов в хранилища.")    -- Вкладка: База предметов    elseif activeTab[0] == 5 then        imgui.Text(u8"База известных предметов:")        imgui.Separator()        imgui.Text(u8"Поиск по названию или ID:")        imgui.PushItemWidth(-5)        imgui.InputText("##itemsearch", itemSearch, ffi.sizeof(itemSearch))        imgui.PopItemWidth()        imgui.Separator()        imgui.BeginChild("items_scroll", imgui.ImVec2(-1, -1), true)            local search = ffi.string(itemSearch):lower()            for _, id in ipairs(items) do                local name = (items_name[id] or "Unknown")                if search == "" or name:lower():find(search, 1, true) or tostring(id):find(search, 1, true) then                    imgui.TextColored(imgui.ImVec4(0.2, 0.5, 1.0, 1.0), "["..id.."]")                    imgui.SameLine(); imgui.Text(u8(name)); imgui.Separator()                end            end        imgui.EndChild()    -- Вкладка: Обновления (ИСПРАВЛЕНА)    elseif activeTab[0] == 2 then        imgui.Text(u8"Обновление системы:")        imgui.Separator()        imgui.Spacing() -- Добавляем немного отступа, чтобы кнопка не прилипала к разделителю        if imgui.Button(u8"Проверить на обновление", imgui.ImVec2(-1, 40)) then checkUpdate(true) end -- Ширина -1 для растягивания, высота 40        imgui.Spacing()        imgui.TextWrapped(u8"Скрипт проверяет наличие новой версии при каждом запуске.")    elseif activeTab[0] == 3 then        imgui.Text(u8"История изменений:"); imgui.Separator()        imgui.BeginChild("news_content", imgui.ImVec2(-5, -5), true)            imgui.TextColored(imgui.ImVec4(0, 1, 0, 1), u8"Обновление 0.1.5:")            imgui.BulletText(u8"Обьединие 2 скриптов в 1'.")            imgui.BulletText(u8"добаротано и отколибровано'.")            imgui.BulletText(u8"База данных предметов отправлена в отдельный лист ")            imgui.Separator()             imgui.EndChild()    elseif activeTab[0] == 4 then        imgui.Text(u8"Настройки Telegram:"); imgui.Separator(); imgui.Spacing()        imgui.Text(u8"ID Чата:"); imgui.PushItemWidth(-5)        if imgui.InputText("##chatid", chat, ffi.sizeof(chat)) then saveConfig() end        imgui.Spacing(); imgui.Text(u8"Токен Бота:");        if imgui.InputText("##token", token, ffi.sizeof(token), imgui.InputTextFlags.Password) then saveConfig() end        imgui.PopItemWidth(); imgui.Spacing()        if imgui.Button(u8"Проверить соединение", imgui.ImVec2(-5, 40)) then             sendTelegramMessage("? ItemLog: Тестовое сообщение. Связь в норме!")         end    end        imgui.Columns(1)    imgui.End()end)-- ЛОГИКА СЕРВЕРАfunction samp.onServerMessage(color, text)    if itemAdding[0] then        local itemId = tonumber(text:match(":item(%d+):"))        if itemId and color == -65281 then            local item_name = items_name[itemId] or ("неизвестный предмет (ID: " .. itemId .. ")")            if not items_name[itemId] and not sendUnknownItems[0] then return end            local msg = shortMessage[0] and ("Получен предмет: " .. item_name) or (items_name[itemId] and ("Вам был добавлен предмет " .. item_name .. ". Откройте инвентарь...") or text)            sendTelegramMessage(msg)            return        end        -- Добавлен этот блок для случая, когда itemAdding[0] включено, но itemID не найден (т.е. обычное сообщение о добавлении)        if color == -65281 and text:find("^Вам был добавлен предмет '.+'%.") then             -- Если sendUnknownItems[0] выключено, но это сообщение о известном предмете, то все равно отправим.             -- Если shortMessage[0] включено, то не отправляем полное сообщение, т.к. уже обработали выше.             if not shortMessage[0] then                sendTelegramMessage(text)             end        end    end    if rentBegin[0] and text:find('арендовал у вас') then sendTelegramMessage(text) end    if rentEnd[0] and (text:find('отказался от аренды') or text:find('была завершена')) then sendTelegramMessage(text) end    if tasks[0] and (text:find("выполнили задание") or text:find("заданий от фермера")) then sendTelegramMessage(text) end    if storage[0] and text:find("Хранилище предметов") then sendTelegramMessage(text) end    if payday[0] then        if text:find('Банковский чек') then getPayday = true; listPayday = {} end        if getPayday then table.insert(listPayday, text) end        if text:find('_________________________________') and getPayday then            sendTelegramMessage(table.concat(listPayday, '\n'))            getPayday = false        end    endendfunction onScriptClose()    if logoTexture then        imgui.destroyTexture(logoTexture)        logoTexture = nil    endend